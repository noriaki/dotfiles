#!/bin/bash
# run_once_before_install.sh - Initial setup script
# This script runs once before chezmoi applies dotfiles

set -e

echo "=== dotfiles initial setup ==="

# -----------------------------------------------------------------------------
# Create XDG directories
# -----------------------------------------------------------------------------
echo "Creating XDG directories..."

mkdir -p "${HOME}/.config"
mkdir -p "${HOME}/.local/share"
mkdir -p "${HOME}/.local/state"
mkdir -p "${HOME}/.cache"

# -----------------------------------------------------------------------------
# Install Homebrew (if not installed)
# -----------------------------------------------------------------------------
HOMEBREW_PREFIX="{{ .homebrew_prefix }}"

if [[ ! -d "${HOMEBREW_PREFIX}" ]]; then
    echo "Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

    # Add Homebrew to PATH for this session
    eval "$(${HOMEBREW_PREFIX}/bin/brew shellenv)"
else
    echo "Homebrew already installed at ${HOMEBREW_PREFIX}"
    eval "$(${HOMEBREW_PREFIX}/bin/brew shellenv)"
fi

# -----------------------------------------------------------------------------
# Install packages via Homebrew Bundle
# -----------------------------------------------------------------------------
BREWFILE="${HOME}/.config/Brewfile"

if [[ -f "${BREWFILE}" ]]; then
    echo "Installing packages from Brewfile..."
    brew bundle --file="${BREWFILE}" --no-lock
else
    echo "Brewfile not found at ${BREWFILE}, skipping brew bundle"
fi

# -----------------------------------------------------------------------------
# Setup mise (version manager)
# -----------------------------------------------------------------------------
if command -v mise &> /dev/null; then
    echo "Setting up mise..."
    mise trust ~/.config/mise/config.toml 2>/dev/null || true
else
    echo "mise not installed yet, will be available after brew bundle"
fi

echo "=== Initial setup complete ==="
