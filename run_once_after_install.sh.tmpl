#!/bin/bash
# run_once_after_install.sh - Post-apply setup script
# This script runs once after chezmoi applies dotfiles

set -e

echo "=== dotfiles post-install setup ==="

# -----------------------------------------------------------------------------
# Install Homebrew (if not installed)
# -----------------------------------------------------------------------------
HOMEBREW_PREFIX="{{ .homebrew_prefix }}"

if [[ ! -d "${HOMEBREW_PREFIX}" ]]; then
    echo "Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi

# Add Homebrew to PATH for this session
eval "$(${HOMEBREW_PREFIX}/bin/brew shellenv)"

# -----------------------------------------------------------------------------
# Install packages via Homebrew Bundle
# -----------------------------------------------------------------------------
BREWFILE="${HOME}/.config/Brewfile"

if [[ -f "${BREWFILE}" ]]; then
    echo "Installing packages from Brewfile..."
    brew bundle --file="${BREWFILE}"
else
    echo "Warning: Brewfile not found at ${BREWFILE}"
fi

# -----------------------------------------------------------------------------
# Setup mise (version manager)
# -----------------------------------------------------------------------------
if command -v mise &> /dev/null; then
    echo "Setting up mise..."
    mise trust ~/.config/mise/config.toml 2>/dev/null || true
    mise install --yes 2>/dev/null || true
else
    echo "Warning: mise not found. Install it via 'brew install mise'"
fi

# -----------------------------------------------------------------------------
# Install global npm packages
# Using npm directly instead of mise npm backend (workaround for timeout issues)
# See: https://github.com/jdx/mise/discussions/4652
# -----------------------------------------------------------------------------
if command -v mise &> /dev/null; then
    echo "Installing global npm packages..."
    eval "$(mise activate bash)"

    if command -v npm &> /dev/null; then
        npm install -g pnpm @anthropic-ai/claude-code || {
            echo "Warning: Failed to install some npm packages"
        }
    else
        echo "Warning: npm not found. Skipping global package installation."
    fi
fi

echo "=== Post-install setup complete ==="
echo ""
echo "Please restart your shell: exec zsh"
